<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Sigma.js v3 -->
    <script src="https://cdn.jsdelivr.net/npm/graphology@0.25.4/dist/graphology.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sigma@3.0.0-beta.27/build/sigma.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            color: #fff; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #graph-container { 
            position: fixed; 
            top: 60px; 
            left: 0; 
            right: 0; 
            bottom: 50px;
            background: radial-gradient(circle at 50% 50%, #1e2a3a 0%, #0f1419 100%);
        }
        #toolbar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 60px; 
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            border-bottom: 2px solid #4299e1; 
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #stats { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 50px; 
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            border-top: 2px solid #4299e1;
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            gap: 20px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .button:active {
            transform: translateY(0);
        }
        #loading { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        #help {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #4299e1;
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1500;
        }
        #help.show { display: block; }
        #help h3 {
            color: #4299e1;
            margin-bottom: 15px;
            font-size: 18px;
        }
        #help ul {
            margin-left: 20px;
            margin-top: 10px;
            line-height: 2;
        }
        #help li {
            margin-bottom: 8px;
        }
        .legend {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #4299e1;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1500;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .legend-text {
            font-size: 13px;
            color: #a0aec0;
        }
        
        /* Tooltip customizado */
        #tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #4299e1;
            border-radius: 8px;
            padding: 12px 16px;
            pointer-events: none;
            display: none;
            z-index: 3000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            max-width: 300px;
        }
        #tooltip .tooltip-title {
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 6px;
            font-size: 14px;
        }
        #tooltip .tooltip-type {
            color: #a0aec0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button class="button" onclick="resetCamera()">üîç Ajustar Zoom</button>
        <button class="button" onclick="centerGraph()">‚Ü∫ Centralizar</button>
        <button class="button" onclick="toggleHelp()">‚ùì Ajuda</button>
        <button class="button" onclick="toggleLegend()">üé® Legenda</button>
        <span style="margin-left:auto;font-weight:bold;font-size:16px;background:linear-gradient(90deg, #667eea, #764ba2);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;">üåê Knowledge Graph (Sigma.js)</span>
    </div>
    
    <div id="help">
        <h3>üí° Como usar:</h3>
        <ul>
            <li><strong>Clique simples:</strong> Expande o n√≥ (carrega filhos)</li>
            <li><strong>Clique duplo:</strong> Abre arquivo (se for Document)</li>
            <li><strong>Borda brilhante:</strong> N√≥ j√° expandido</li>
            <li><strong>Scroll:</strong> Zoom in/out</li>
            <li><strong>Arrastar:</strong> Move o canvas</li>
            <li><strong>Hover:</strong> Destaca n√≥ e conex√µes</li>
        </ul>
    </div>
    
    <div class="legend" id="legend" style="display: none;">
        <div style="font-weight: bold; margin-bottom: 12px; color: #4299e1; font-size: 15px;">üìä Tipos de N√≥s</div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #4299e1, #2b6cb0);"></div>
            <span class="legend-text">üìÑ Document</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #48bb78, #2f855a);"></div>
            <span class="legend-text">üìù Section</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ed8936, #c05621);"></div>
            <span class="legend-text">üè∑Ô∏è Keyword</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #9f7aea, #6b46c1);"></div>
            <span class="legend-text">üîó Entity</span>
        </div>
    </div>
    
    <div id="graph-container"></div>
    <div id="loading"><h2>‚è≥ Carregando Knowledge Graph...</h2></div>
    <div id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-type"></div>
    </div>
    
    <div id="stats">
        <span id="st" style="color: #cbd5e0;">Aguardando...</span>
        <span style="margin-left: auto; color: #cbd5e0;">
            <strong style="color: #4299e1;">Vis√≠veis:</strong> <span id="visibleNodes">0</span> n√≥s | <span id="visibleEdges">0</span> conex√µes
        </span>
    </div>

    <script>
        console.log('[webview] Starting Sigma.js progressive graph...');
        const vscode = acquireVsCodeApi();
        let sigma = null;
        let graph = null;
        const expandedNodes = new Set();
        let hoveredNode = null;
        let clickTimeout = null;
        
        // Cores por tipo
        const typeColors = {
            'Document': '#4299e1',
            'Section': '#48bb78',
            'Entity': '#9f7aea',
            'Keyword': '#ed8936'
        };
        
        // √çcones por tipo
        const typeIcons = {
            'Document': 'üìÑ',
            'Section': 'üìù',
            'Entity': 'üîó',
            'Keyword': 'üè∑Ô∏è'
        };
        
        // Tamanhos por tipo
        const typeSizes = {
            'Document': 20,
            'Section': 15,
            'Entity': 12,
            'Keyword': 12
        };
        
        // Enviar ready para carregar n√≥s raiz
        vscode.postMessage({ command: 'ready' });
        
        window.addEventListener('message', e => {
            console.log('[webview] Message:', e.data.command);
            
            if (e.data.command === 'loadGraph') {
                const d = e.data.data;
                console.log('[webview] Loading initial:', d.nodes.length, 'root nodes');
                
                if (d.nodes.length === 0) {
                    document.getElementById('loading').innerHTML = '<h2>‚ö†Ô∏è Nenhum dado. Execute CAPPY: Reindex Workspace</h2>';
                    return;
                }
                
                document.getElementById('loading').style.display = 'none';
                initializeGraph(d);
                updateStats();
            }
            else if (e.data.command === 'addNodes') {
                const d = e.data.data;
                console.log('[webview] Adding:', d.nodes.length, 'nodes,', d.edges.length, 'edges');
                addNodesToGraph(d);
                updateStats();
            }
        });
        
        function initializeGraph(data) {
            // Criar grafo usando Graphology
            graph = new graphology.Graph();
            
            // Adicionar n√≥s iniciais
            data.nodes.forEach(node => {
                const type = node.type || 'Keyword';
                const label = node.label || node.id;
                
                graph.addNode(node.id, {
                    label: label,
                    type: type,
                    path: node.path,
                    expanded: false,
                    x: Math.random() * 1000,
                    y: Math.random() * 1000,
                    size: typeSizes[type] || 12,
                    color: typeColors[type] || '#ed8936',
                    borderSize: 2,
                    borderColor: 'rgba(255, 255, 255, 0.3)'
                });
            });
            
            // Inicializar Sigma
            const container = document.getElementById('graph-container');
            sigma = new Sigma(graph, container, {
                renderLabels: true,
                labelRenderer: customLabelRenderer,
                defaultNodeColor: '#ed8936',
                defaultEdgeColor: '#4a5568',
                labelSize: 12,
                labelWeight: 'bold',
                labelColor: { color: '#ffffff' },
                edgeProgramClasses: {
                    arrow: Sigma.EdgeArrowProgram
                },
                minCameraRatio: 0.1,
                maxCameraRatio: 10
            });
            
            // Aplicar layout ForceAtlas2
            applyLayout();
            
            // Event handlers
            sigma.on('clickNode', handleNodeClick);
            sigma.on('doubleClickNode', handleNodeDoubleClick);
            sigma.on('enterNode', handleNodeEnter);
            sigma.on('leaveNode', handleNodeLeave);
            
            console.log('[webview] Sigma.js graph initialized!');
        }
        
        // Custom label renderer com √≠cones
        function customLabelRenderer(context, data, settings) {
            const size = settings.labelSize;
            const font = settings.labelWeight + ' ' + size + 'px ' + settings.labelFont;
            const type = data.type || 'Keyword';
            const icon = typeIcons[type] || 'üè∑Ô∏è';
            const label = data.label;
            
            context.font = font;
            context.fillStyle = '#ffffff';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            
            // Desenhar √≠cone + label
            const text = icon + ' ' + (label.length > 15 ? label.substring(0, 15) + '...' : label);
            
            // Background do texto
            const textWidth = context.measureText(text).width;
            const padding = 6;
            
            context.fillStyle = 'rgba(0, 0, 0, 0.8)';
            context.fillRect(
                data.x - textWidth / 2 - padding,
                data.y + data.size + 8 - size / 2,
                textWidth + padding * 2,
                size + padding
            );
            
            // Texto
            context.fillStyle = '#ffffff';
            context.fillText(text, data.x, data.y + data.size + 12);
        }
        
        function applyLayout() {
            if (!graph) return;
            
            // Layout circular simples para come√ßar
            const nodes = graph.nodes();
            const angleStep = (2 * Math.PI) / nodes.length;
            const radius = 300;
            
            nodes.forEach((node, i) => {
                const angle = i * angleStep;
                graph.setNodeAttribute(node, 'x', Math.cos(angle) * radius);
                graph.setNodeAttribute(node, 'y', Math.sin(angle) * radius);
            });
        }
        
        function handleNodeClick({ node }) {
            if (clickTimeout) {
                // √â um duplo clique, n√£o processar
                clearTimeout(clickTimeout);
                clickTimeout = null;
                return;
            }
            
            clickTimeout = setTimeout(() => {
                clickTimeout = null;
                
                if (expandedNodes.has(node)) {
                    console.log('[webview] Node already expanded:', node);
                    return;
                }
                
                console.log('[webview] Expanding node:', node);
                expandedNodes.add(node);
                
                // Atualizar visual do n√≥
                graph.setNodeAttribute(node, 'expanded', true);
                graph.setNodeAttribute(node, 'borderSize', 4);
                graph.setNodeAttribute(node, 'borderColor', '#48bb78');
                
                // Requisitar expans√£o ao backend
                vscode.postMessage({ command: 'expandNode', nodeId: node });
            }, 250);
        }
        
        function handleNodeDoubleClick({ node }) {
            if (clickTimeout) {
                clearTimeout(clickTimeout);
                clickTimeout = null;
            }
            
            const path = graph.getNodeAttribute(node, 'path');
            if (path) {
                console.log('[webview] Opening file:', path);
                vscode.postMessage({ command: 'openFile', filePath: path });
            }
        }
        
        function handleNodeEnter({ node }) {
            hoveredNode = node;
            
            // Destacar n√≥
            graph.setNodeAttribute(node, 'size', graph.getNodeAttribute(node, 'size') * 1.3);
            graph.setNodeAttribute(node, 'highlighted', true);
            
            // Destacar edges conectados
            graph.edges().forEach(edge => {
                const [source, target] = graph.extremities(edge);
                if (source === node || target === node) {
                    graph.setEdgeAttribute(edge, 'size', 3);
                    graph.setEdgeAttribute(edge, 'color', '#f6e05e');
                }
            });
            
            // Mostrar tooltip
            showTooltip(node);
            
            sigma.refresh();
        }
        
        function handleNodeLeave({ node }) {
            hoveredNode = null;
            
            // Restaurar n√≥
            const type = graph.getNodeAttribute(node, 'type');
            graph.setNodeAttribute(node, 'size', typeSizes[type] || 12);
            graph.setNodeAttribute(node, 'highlighted', false);
            
            // Restaurar edges
            graph.edges().forEach(edge => {
                const [source, target] = graph.extremities(edge);
                if (source === node || target === node) {
                    graph.setEdgeAttribute(edge, 'size', 2);
                    const sourceType = graph.getNodeAttribute(source, 'type');
                    graph.setEdgeAttribute(edge, 'color', typeColors[sourceType] || '#4a5568');
                }
            });
            
            // Ocultar tooltip
            hideTooltip();
            
            sigma.refresh();
        }
        
        function showTooltip(node) {
            const tooltip = document.getElementById('tooltip');
            const label = graph.getNodeAttribute(node, 'label');
            const type = graph.getNodeAttribute(node, 'type');
            const icon = typeIcons[type] || 'üè∑Ô∏è';
            
            tooltip.querySelector('.tooltip-title').textContent = icon + ' ' + label;
            tooltip.querySelector('.tooltip-type').textContent = 'Type: ' + type;
            tooltip.style.display = 'block';
            
            // Posicionar pr√≥ximo ao cursor
            document.addEventListener('mousemove', updateTooltipPosition);
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'none';
            document.removeEventListener('mousemove', updateTooltipPosition);
        }
        
        function updateTooltipPosition(e) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        }
        
        function addNodesToGraph(data) {
            if (!graph) return;
            
            // Adicionar novos n√≥s
            data.nodes.forEach(node => {
                if (!graph.hasNode(node.id)) {
                    const type = node.type || 'Keyword';
                    const label = node.label || node.id;
                    
                    graph.addNode(node.id, {
                        label: label,
                        type: type,
                        path: node.path,
                        expanded: false,
                        x: Math.random() * 1000 - 500,
                        y: Math.random() * 1000 - 500,
                        size: typeSizes[type] || 12,
                        color: typeColors[type] || '#ed8936',
                        borderSize: 2,
                        borderColor: 'rgba(255, 255, 255, 0.3)'
                    });
                }
            });
            
            // Adicionar edges
            data.edges.forEach(edge => {
                const edgeId = edge.id || `${edge.source}-${edge.target}`;
                if (!graph.hasEdge(edgeId) && graph.hasNode(edge.source) && graph.hasNode(edge.target)) {
                    const sourceType = graph.getNodeAttribute(edge.source, 'type');
                    
                    graph.addEdge(edge.source, edge.target, {
                        id: edgeId,
                        size: 2,
                        color: typeColors[sourceType] || '#4a5568',
                        type: 'arrow'
                    });
                }
            });
            
            // Reaplicar layout
            applyLayout();
            sigma.refresh();
        }
        
        function updateStats() {
            if (!graph) return;
            const nodeCount = graph.order;
            const edgeCount = graph.size;
            document.getElementById('visibleNodes').textContent = nodeCount;
            document.getElementById('visibleEdges').textContent = edgeCount;
            document.getElementById('st').innerHTML = 
                `<strong>${expandedNodes.size}</strong> n√≥s expandidos | <strong>${nodeCount - expandedNodes.size}</strong> podem ser expandidos`;
        }
        
        function resetCamera() { 
            if (sigma) {
                sigma.getCamera().animatedReset();
            }
        }
        
        function centerGraph() { 
            if (sigma) {
                sigma.getCamera().animatedReset();
            }
        }
        
        function toggleHelp() {
            const help = document.getElementById('help');
            help.classList.toggle('show');
        }
        
        function toggleLegend() {
            const legend = document.getElementById('legend');
            legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
