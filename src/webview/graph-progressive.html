<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #1e1e1e; 
            color: #fff; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #cy { 
            position: fixed; 
            top: 50px; 
            left: 0; 
            right: 0; 
            bottom: 40px; 
        }
        #toolbar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 50px; 
            background: #252526; 
            border-bottom: 1px solid #3e3e42; 
            padding: 0 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        #stats { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 40px; 
            background: #007acc; 
            padding: 0 15px; 
            display: flex; 
            align-items: center; 
            gap: 15px;
        }
        .button { 
            background: #0e639c; 
            color: #fff; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-size: 13px;
        }
        .button:hover { background: #1177bb; }
        #loading { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center; 
        }
        .expanded { border: 2px solid #7ED321 !important; }
        .loading-node { opacity: 0.5; }
        #help {
            position: fixed;
            top: 60px;
            right: 20px;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
            max-width: 300px;
            display: none;
        }
        #help.show { display: block; }
    </style>
</head>
<body>
    <div id="toolbar">
        <button class="button" onclick="fit()">üîç Fit</button>
        <button class="button" onclick="reset()">‚Ü∫ Reset</button>
        <button class="button" onclick="toggleHelp()">‚ùì Ajuda</button>
        <span style="margin-left:auto;font-weight:bold">üåê Mini-LightRAG Graph (Progressive)</span>
    </div>
    
    <div id="help">
        <h3>üí° Como usar:</h3>
        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
            <li><strong>Clique simples:</strong> Expande o n√≥ (carrega filhos)</li>
            <li><strong>Clique duplo:</strong> Abre arquivo (se for Document)</li>
            <li><strong>Verde:</strong> N√≥ j√° expandido</li>
            <li><strong>Azul:</strong> Document (raiz)</li>
            <li><strong>Laranja:</strong> Section/Keyword</li>
        </ul>
    </div>
    
    <div id="cy"></div>
    <div id="loading"><h2>‚è≥ Carregando n√≥s raiz...</h2></div>
    
    <div id="stats">
        <span id="st">Aguardando...</span>
        <span style="margin-left: auto;">
            <strong>Vis√≠veis:</strong> <span id="visibleNodes">0</span> n√≥s, <span id="visibleEdges">0</span> edges
        </span>
    </div>

    <script>
        console.log('[webview] Starting progressive graph...');
        const vscode = acquireVsCodeApi();
        let cy = null;
        const expandedNodes = new Set(); // Track n√≥s j√° expandidos
        
        // Enviar ready para carregar n√≥s raiz
        vscode.postMessage({ command: 'ready' });
        
        window.addEventListener('message', e => {
            console.log('[webview] Message:', e.data.command);
            
            if (e.data.command === 'loadGraph') {
                const d = e.data.data;
                console.log('[webview] Loading initial:', d.nodes.length, 'root nodes');
                
                if (d.nodes.length === 0) {
                    document.getElementById('loading').innerHTML = '<h2>‚ö†Ô∏è Nenhum dado. Execute CAPPY: Reindex Workspace</h2>';
                    return;
                }
                
                document.getElementById('loading').style.display = 'none';
                initializeGraph(d);
                updateStats();
            }
            else if (e.data.command === 'addNodes') {
                const d = e.data.data;
                console.log('[webview] Adding:', d.nodes.length, 'nodes,', d.edges.length, 'edges');
                addNodesToGraph(d);
                updateStats();
            }
        });
        
        function initializeGraph(data) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: {
                    nodes: data.nodes.map(n => ({
                        data: { 
                            id: n.id, 
                            label: n.label, 
                            type: n.type, 
                            path: n.path,
                            expanded: false
                        }
                    })),
                    edges: []
                },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'font-size': '12px',
                            'width': 40,
                            'height': 40,
                            'background-color': function(ele) {
                                const t = ele.data('type');
                                return t === 'Document' ? '#4A90E2' : 
                                       t === 'Section' ? '#7ED321' : '#F5A623';
                            },
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'border-width': function(ele) {
                                return ele.data('expanded') ? 3 : 0;
                            },
                            'border-color': '#7ED321'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#666',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': '#666',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: '.loading-node',
                        style: { 'opacity': 0.5 }
                    }
                ],
                layout: {
                    name: 'cose',
                    fit: true,
                    padding: 50,
                    animate: true,
                    animationDuration: 500
                }
            });
            
            // Clique simples: expandir
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const nodeId = node.data('id');
                
                if (expandedNodes.has(nodeId)) {
                    console.log('[webview] Node already expanded:', nodeId);
                    return;
                }
                
                console.log('[webview] Expanding node:', nodeId);
                expandedNodes.add(nodeId);
                node.data('expanded', true);
                node.addClass('loading-node');
                
                // Requisitar expans√£o ao backend
                vscode.postMessage({ command: 'expandNode', nodeId: nodeId });
            });
            
            // Clique duplo: abrir arquivo
            cy.on('dbltap', 'node', function(evt) {
                const path = evt.target.data('path');
                if (path) {
                    console.log('[webview] Opening file:', path);
                    vscode.postMessage({ command: 'openFile', filePath: path });
                }
            });
            
            console.log('[webview] Graph initialized!');
        }
        
        function addNodesToGraph(data) {
            if (!cy) return;
            
            // Adicionar novos n√≥s
            data.nodes.forEach(n => {
                // Verificar se j√° existe
                if (cy.getElementById(n.id).length === 0) {
                    cy.add({
                        data: { 
                            id: n.id, 
                            label: n.label, 
                            type: n.type, 
                            path: n.path,
                            expanded: false
                        }
                    });
                }
            });
            
            // Adicionar edges
            data.edges.forEach(e => {
                if (cy.getElementById(e.id).length === 0) {
                    cy.add({
                        data: { 
                            id: e.id, 
                            source: e.source, 
                            target: e.target 
                        }
                    });
                }
            });
            
            // Remover loading do n√≥ expandido
            cy.nodes('.loading-node').removeClass('loading-node');
            
            // Animar layout
            cy.layout({
                name: 'cose',
                fit: false,
                animate: true,
                animationDuration: 500,
                randomize: false
            }).run();
        }
        
        function updateStats() {
            if (!cy) return;
            const nodeCount = cy.nodes().length;
            const edgeCount = cy.edges().length;
            document.getElementById('visibleNodes').textContent = nodeCount;
            document.getElementById('visibleEdges').textContent = edgeCount;
            document.getElementById('st').innerHTML = 
                `<strong>${expandedNodes.size}</strong> n√≥s expandidos | <strong>${nodeCount - expandedNodes.size}</strong> podem ser expandidos`;
        }
        
        function fit() { 
            if (cy) cy.fit(null, 50); 
        }
        
        function reset() { 
            if (cy) {
                cy.zoom(1);
                cy.center();
            }
        }
        
        function toggleHelp() {
            const help = document.getElementById('help');
            help.classList.toggle('show');
        }
    </script>
</body>
</html>
