<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            color: #fff; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #cy { 
            position: fixed; 
            top: 60px; 
            left: 0; 
            right: 0; 
            bottom: 50px;
            background: radial-gradient(circle at 50% 50%, #1e2a3a 0%, #0f1419 100%);
        }
        #toolbar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 60px; 
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            border-bottom: 2px solid #4299e1; 
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        #stats { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 50px; 
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            border-top: 2px solid #4299e1;
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            gap: 20px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
        }
        .button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .button:active {
            transform: translateY(0);
        }
        #loading { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .loading-node { opacity: 0.5; }
        #help {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #4299e1;
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        #help.show { display: block; }
        #help h3 {
            color: #4299e1;
            margin-bottom: 15px;
            font-size: 18px;
        }
        #help ul {
            margin-left: 20px;
            margin-top: 10px;
            line-height: 2;
        }
        #help li {
            margin-bottom: 8px;
        }
        .legend {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #4299e1;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .legend-icon {
            font-size: 24px;
        }
        .legend-text {
            font-size: 13px;
            color: #a0aec0;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button class="button" onclick="fit()">üîç Ajustar Zoom</button>
        <button class="button" onclick="reset()">‚Ü∫ Resetar</button>
        <button class="button" onclick="toggleHelp()">‚ùì Ajuda</button>
        <button class="button" onclick="toggleLegend()">üé® Legenda</button>
        <span style="margin-left:auto;font-weight:bold;font-size:16px;background:linear-gradient(90deg, #667eea, #764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üåê Knowledge Graph</span>
    </div>
    
    <div id="help">
        <h3>üí° Como usar:</h3>
        <ul>
            <li><strong>Clique simples:</strong> Expande o n√≥ (carrega filhos)</li>
            <li><strong>Clique duplo:</strong> Abre arquivo (se for Document)</li>
            <li><strong>Borda verde:</strong> N√≥ j√° expandido</li>
            <li><strong>Scroll:</strong> Zoom in/out</li>
            <li><strong>Arrastar:</strong> Move o canvas</li>
        </ul>
    </div>
    
    <div class="legend" id="legend" style="display: none;">
        <div style="font-weight: bold; margin-bottom: 12px; color: #4299e1; font-size: 15px;">üìä Tipos de N√≥s</div>
        <div class="legend-item">
            <span class="legend-icon">üìÑ</span>
            <span class="legend-text">Document (Azul)</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon">üìù</span>
            <span class="legend-text">Section (Verde)</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon">üè∑Ô∏è</span>
            <span class="legend-text">Keyword (Laranja)</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon">üîó</span>
            <span class="legend-text">Entity (Roxo)</span>
        </div>
    </div>
    
    <div id="cy"></div>
    <div id="loading"><h2>‚è≥ Carregando Knowledge Graph...</h2></div>
    
    <div id="stats">
        <span id="st" style="color: #cbd5e0;">Aguardando...</span>
        <span style="margin-left: auto; color: #cbd5e0;">
            <strong style="color: #4299e1;">Vis√≠veis:</strong> <span id="visibleNodes">0</span> n√≥s | <span id="visibleEdges">0</span> conex√µes
        </span>
    </div>

    <script>
        console.log('[webview] Starting progressive graph...');
        const vscode = acquireVsCodeApi();
        let cy = null;
        const expandedNodes = new Set(); // Track n√≥s j√° expandidos
        
        // Enviar ready para carregar n√≥s raiz
        vscode.postMessage({ command: 'ready' });
        
        window.addEventListener('message', e => {
            console.log('[webview] Message:', e.data.command);
            
            if (e.data.command === 'loadGraph') {
                const d = e.data.data;
                console.log('[webview] Loading initial:', d.nodes.length, 'root nodes');
                
                if (d.nodes.length === 0) {
                    document.getElementById('loading').innerHTML = '<h2>‚ö†Ô∏è Nenhum dado. Execute CAPPY: Reindex Workspace</h2>';
                    return;
                }
                
                document.getElementById('loading').style.display = 'none';
                initializeGraph(d);
                updateStats();
            }
            else if (e.data.command === 'addNodes') {
                const d = e.data.data;
                console.log('[webview] Adding:', d.nodes.length, 'nodes,', d.edges.length, 'edges');
                addNodesToGraph(d);
                updateStats();
            }
        });
        
        function initializeGraph(data) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: {
                    nodes: data.nodes.map(n => ({
                        data: { 
                            id: n.id, 
                            label: n.label, 
                            type: n.type, 
                            path: n.path,
                            expanded: false
                        }
                    })),
                    edges: []
                },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': function(ele) {
                                const t = ele.data('type');
                                const label = ele.data('label');
                                const icon = t === 'Document' ? 'üìÑ' : 
                                           t === 'Section' ? 'üìù' : 
                                           t === 'Entity' ? 'üîó' : 'üè∑Ô∏è';
                                return icon + ' ' + (label.length > 15 ? label.substring(0, 15) + '...' : label);
                            },
                            'font-size': '11px',
                            'font-weight': 'bold',
                            'width': function(ele) {
                                return ele.data('type') === 'Document' ? 70 : 50;
                            },
                            'height': function(ele) {
                                return ele.data('type') === 'Document' ? 70 : 50;
                            },
                            'background-color': function(ele) {
                                const t = ele.data('type');
                                return t === 'Document' ? '#4299e1' : 
                                       t === 'Section' ? '#48bb78' : 
                                       t === 'Entity' ? '#9f7aea' : '#ed8936';
                            },
                            'background-gradient-stop-colors': function(ele) {
                                const t = ele.data('type');
                                if (t === 'Document') return '#4299e1 #2b6cb0';
                                if (t === 'Section') return '#48bb78 #2f855a';
                                if (t === 'Entity') return '#9f7aea #6b46c1';
                                return '#ed8936 #c05621';
                            },
                            'background-gradient-stop-positions': '0% 100%',
                            'color': '#ffffff',
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'text-margin-y': 8,
                            'text-background-color': 'rgba(0, 0, 0, 0.7)',
                            'text-background-opacity': 1,
                            'text-background-padding': '4px',
                            'text-background-shape': 'roundrectangle',
                            'border-width': function(ele) {
                                return ele.data('expanded') ? 4 : 2;
                            },
                            'border-color': function(ele) {
                                return ele.data('expanded') ? '#48bb78' : 'rgba(255, 255, 255, 0.3)';
                            },
                            'border-style': function(ele) {
                                return ele.data('expanded') ? 'solid' : 'solid';
                            },
                            'shadow-blur': 20,
                            'shadow-color': function(ele) {
                                const t = ele.data('type');
                                if (t === 'Document') return 'rgba(66, 153, 225, 0.6)';
                                if (t === 'Section') return 'rgba(72, 187, 120, 0.6)';
                                if (t === 'Entity') return 'rgba(159, 122, 234, 0.6)';
                                return 'rgba(237, 137, 54, 0.6)';
                            },
                            'shadow-offset-x': 0,
                            'shadow-offset-y': 4,
                            'transition-property': 'background-color, border-width, border-color',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 5,
                            'border-color': '#f6e05e',
                            'shadow-blur': 30,
                            'shadow-color': 'rgba(246, 224, 94, 0.8)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': function(ele) {
                                const sourceType = cy.getElementById(ele.data('source')).data('type');
                                if (sourceType === 'Document') return '#4299e1';
                                if (sourceType === 'Section') return '#48bb78';
                                if (sourceType === 'Entity') return '#9f7aea';
                                return '#ed8936';
                            },
                            'line-style': 'solid',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': function(ele) {
                                const sourceType = cy.getElementById(ele.data('source')).data('type');
                                if (sourceType === 'Document') return '#4299e1';
                                if (sourceType === 'Section') return '#48bb78';
                                if (sourceType === 'Entity') return '#9f7aea';
                                return '#ed8936';
                            },
                            'curve-style': 'bezier',
                            'opacity': 0.7,
                            'arrow-scale': 1.5
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'width': 5,
                            'line-color': '#f6e05e',
                            'target-arrow-color': '#f6e05e',
                            'opacity': 1
                        }
                    },
                    {
                        selector: '.loading-node',
                        style: { 
                            'opacity': 0.5,
                            'text-opacity': 0.5
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    fit: true,
                    padding: 80,
                    animate: true,
                    animationDuration: 1000,
                    animationEasing: 'ease-out',
                    nodeRepulsion: 8000,
                    idealEdgeLength: 100,
                    edgeElasticity: 200,
                    nestingFactor: 5,
                    gravity: 0.8,
                    numIter: 1000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0
                }
            });
            
            // Clique simples: expandir
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const nodeId = node.data('id');
                
                if (expandedNodes.has(nodeId)) {
                    console.log('[webview] Node already expanded:', nodeId);
                    return;
                }
                
                console.log('[webview] Expanding node:', nodeId);
                expandedNodes.add(nodeId);
                node.data('expanded', true);
                node.addClass('loading-node');
                
                // Requisitar expans√£o ao backend
                vscode.postMessage({ command: 'expandNode', nodeId: nodeId });
            });
            
            // Clique duplo: abrir arquivo
            cy.on('dbltap', 'node', function(evt) {
                const path = evt.target.data('path');
                if (path) {
                    console.log('[webview] Opening file:', path);
                    vscode.postMessage({ command: 'openFile', filePath: path });
                }
            });
            
            // Efeito hover nos n√≥s
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                node.animate({
                    style: { 
                        'width': node.style('width') * 1.2,
                        'height': node.style('height') * 1.2
                    }
                }, {
                    duration: 200
                });
                
                // Destacar conex√µes
                node.connectedEdges().animate({
                    style: { 'width': 5, 'opacity': 1 }
                }, {
                    duration: 200
                });
            });
            
            cy.on('mouseout', 'node', function(evt) {
                const node = evt.target;
                const originalSize = node.data('type') === 'Document' ? 70 : 50;
                node.animate({
                    style: { 
                        'width': originalSize,
                        'height': originalSize
                    }
                }, {
                    duration: 200
                });
                
                // Restaurar conex√µes
                node.connectedEdges().animate({
                    style: { 'width': 3, 'opacity': 0.7 }
                }, {
                    duration: 200
                });
            });
            
            console.log('[webview] Graph initialized!');
        }
        
        function addNodesToGraph(data) {
            if (!cy) return;
            
            // Adicionar novos n√≥s
            data.nodes.forEach(n => {
                // Verificar se j√° existe
                if (cy.getElementById(n.id).length === 0) {
                    cy.add({
                        data: { 
                            id: n.id, 
                            label: n.label, 
                            type: n.type, 
                            path: n.path,
                            expanded: false
                        }
                    });
                }
            });
            
            // Adicionar edges
            data.edges.forEach(e => {
                if (cy.getElementById(e.id).length === 0) {
                    cy.add({
                        data: { 
                            id: e.id, 
                            source: e.source, 
                            target: e.target 
                        }
                    });
                }
            });
            
            // Remover loading do n√≥ expandido
            cy.nodes('.loading-node').removeClass('loading-node');
            
            // Animar layout
            cy.layout({
                name: 'cose',
                fit: false,
                animate: true,
                animationDuration: 800,
                animationEasing: 'ease-out',
                randomize: false,
                nodeRepulsion: 8000,
                idealEdgeLength: 100,
                edgeElasticity: 200,
                nestingFactor: 5,
                gravity: 0.8,
                numIter: 500
            }).run();
        }
        
        function updateStats() {
            if (!cy) return;
            const nodeCount = cy.nodes().length;
            const edgeCount = cy.edges().length;
            document.getElementById('visibleNodes').textContent = nodeCount;
            document.getElementById('visibleEdges').textContent = edgeCount;
            document.getElementById('st').innerHTML = 
                `<strong>${expandedNodes.size}</strong> n√≥s expandidos | <strong>${nodeCount - expandedNodes.size}</strong> podem ser expandidos`;
        }
        
        function fit() { 
            if (cy) cy.fit(null, 50); 
        }
        
        function reset() { 
            if (cy) {
                cy.zoom(1);
                cy.center();
            }
        }
        
        function toggleHelp() {
            const help = document.getElementById('help');
            help.classList.toggle('show');
        }
        
        function toggleLegend() {
            const legend = document.getElementById('legend');
            legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
