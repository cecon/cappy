<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph - CappyRAG</title>
    <!-- D3_PLACEHOLDER -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            overflow: hidden;
        }

        /* Header Navigation */
        .header {
            background: #252526;
            border-bottom: 1px solid #3c3c3c;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #1177bb;
        }

        .title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-right {
            display: flex;
            gap: 12px;
        }

        .header-button {
            background: transparent;
            color: #cccccc;
            border: 1px solid #3c3c3c;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .header-button:hover {
            background: #2a2d2e;
            border-color: #0e639c;
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 48px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            padding: 16px;
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 24px;
        }

        .filter-section h3 {
            font-size: 13px;
            margin-bottom: 12px;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-input {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #cccccc;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
        }

        .search-input:focus {
            outline: none;
            border-color: #0e639c;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .checkbox-item input {
            cursor: pointer;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider {
            width: 100%;
            cursor: pointer;
        }

        .slider-value {
            font-size: 12px;
            color: #858585;
        }

        .select-input {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #cccccc;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        /* Graph Container */
        .graph-container {
            flex: 1;
            position: relative;
            background: #1e1e1e;
        }

        #graph-svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #graph-svg:active {
            cursor: grabbing;
        }

        /* Controls */
        .graph-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-button {
            background: #252526;
            border: 1px solid #3c3c3c;
            color: #cccccc;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: #2a2d2e;
            border-color: #0e639c;
        }

        /* Stats Bar */
        .stats-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #252526;
            border-top: 1px solid #3c3c3c;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .stats-group {
            display: flex;
            gap: 24px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-label {
            color: #858585;
        }

        .stat-value {
            color: #0e639c;
            font-weight: 600;
        }

        /* Legend */
        .legend {
            position: absolute;
            top: 16px;
            left: 16px;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 12px;
            font-size: 11px;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #3c3c3c;
            border-top-color: #0e639c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #0e639c;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin: 2px 0;
        }

        .tooltip-label {
            color: #858585;
        }

        .tooltip-value {
            color: #cccccc;
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">
                ‚Üê Back to Dashboard
            </button>
            <div class="title">
                üìä Knowledge Graph
            </div>
        </div>
        <div class="header-right">
            <button class="header-button" onclick="resetView()">üîÑ Reset View</button>
            <button class="header-button" onclick="exportImage()">üíæ Export</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Filters -->
        <div class="sidebar">
            <div class="filter-section">
                <h3>Search</h3>
                <input type="text" class="search-input" id="search-input" placeholder="Search nodes...">
            </div>

            <div class="filter-section">
                <h3>Node Types</h3>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="filter-documents" checked>
                        <span>Documents</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="filter-entities" checked>
                        <span>Entities</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="filter-relationships" checked>
                        <span>Relationships</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="filter-chunks" checked>
                        <span>Chunks</span>
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <h3>Confidence</h3>
                <div class="slider-container">
                    <input type="range" class="slider" id="confidence-slider" min="0" max="100" value="0">
                    <div class="slider-value">Min: <span id="confidence-value">0</span>%</div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Category</h3>
                <select class="select-input" id="category-filter">
                    <option value="">All Categories</option>
                </select>
            </div>
        </div>

        <!-- Graph Container -->
        <div class="graph-container">
            <svg id="graph-svg"></svg>
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div style="margin-top: 16px;">Loading graph data...</div>
            </div>

            <!-- Controls -->
            <div class="graph-controls">
                <button class="control-button" onclick="zoomIn()">üîç Zoom In</button>
                <button class="control-button" onclick="zoomOut()">üîç Zoom Out</button>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Node Types</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4a9eff;"></div>
                    <span>Documents</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ec9b0;"></div>
                    <span>Entities</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ce9178;"></div>
                    <span>Relationships</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #c586c0;"></div>
                    <span>Chunks</span>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stats-group">
                    <div class="stat-item">
                        <span class="stat-label">Nodes:</span>
                        <span class="stat-value" id="stat-nodes">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Edges:</span>
                        <span class="stat-value" id="stat-edges">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Filtered:</span>
                        <span class="stat-value" id="stat-filtered">0</span>
                    </div>
                </div>
                <div class="stats-group">
                    <div class="stat-item">
                        <span class="stat-label">Avg Confidence:</span>
                        <span class="stat-value" id="stat-confidence">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VS Code API
        const vscode = acquireVsCodeApi();
        
        // State
        let graphData = null;
        let simulation = null;
        let svg = null;
        let g = null;
        let zoom = null;
        let isInitialized = false;
        let dataRequested = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Graph Page] Initializing...');
            if (!dataRequested) {
                dataRequested = true;
                requestGraphData();
            }
        });

        // Request graph data from extension
        function requestGraphData() {
            console.log('[Graph Page] Requesting graph data...');
            vscode.postMessage({ command: 'getGraphData' });
        }

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            
            if (message.command === 'graphData') {
                console.log('[Graph Page] Received graph data:', message.data);
                console.log('[Graph Page] Nodes:', message.data.nodes?.length, 'Edges:', message.data.edges?.length);
                
                // Prevent duplicate initialization
                if (isInitialized) {
                    console.warn('[Graph Page] Already initialized, skipping duplicate data');
                    return;
                }
                
                graphData = message.data;
                isInitialized = true;
                initializeGraph();
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Navigate back to dashboard
        function goBack() {
            vscode.postMessage({ command: 'backToDashboard' });
        }

        // Initialize D3.js graph
        function initializeGraph() {
            if (!graphData || !graphData.nodes || !graphData.edges) return;

            const width = window.innerWidth - 280;
            const height = window.innerHeight - 48 - 49; // header + stats bar

            // Setup SVG
            svg = d3.select('#graph-svg')
                .attr('width', width)
                .attr('height', height);

            // Setup zoom
            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Main group
            g = svg.append('g');

            // Setup simulation
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.edges)
                    .id(d => d.id)
                    .distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            renderGraph();
            updateStats();
        }

        // Render graph
        function renderGraph() {
            // Clear existing
            g.selectAll('*').remove();

            // Draw edges
            const links = g.append('g')
                .selectAll('line')
                .data(graphData.edges)
                .enter()
                .append('line')
                .attr('stroke', '#3c3c3c')
                .attr('stroke-width', 1)
                .attr('opacity', 0.6);

            // Draw nodes
            const nodes = g.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .enter()
                .append('circle')
                .attr('r', d => getNodeSize(d))
                .attr('fill', d => getNodeColor(d))
                .attr('stroke', '#1e1e1e')
                .attr('stroke-width', 2)
                .call(drag(simulation));

            // Update positions
            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodes
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
            });
        }

        // Helper functions
        function getNodeColor(node) {
            const colors = {
                'document': '#4a9eff',
                'entity': '#4ec9b0',
                'relationship': '#ce9178',
                'chunk': '#c586c0'
            };
            return colors[node.type] || '#cccccc';
        }

        function getNodeSize(node) {
            return node.importance ? 5 + (node.importance * 15) : 8;
        }

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        function updateStats() {
            document.getElementById('stat-nodes').textContent = graphData.nodes.length;
            document.getElementById('stat-edges').textContent = graphData.edges.length;
            document.getElementById('stat-filtered').textContent = graphData.nodes.length;
            
            if (graphData.statistics) {
                document.getElementById('stat-confidence').textContent = 
                    (graphData.statistics.avgConfidence || 0).toFixed(1) + '%';
            }
        }

        function resetView() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
        }

        function zoomIn() {
            svg.transition().duration(750).call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition().duration(750).call(zoom.scaleBy, 0.7);
        }

        function exportImage() {
            alert('Export feature coming soon!');
        }

        // Window resize
        window.addEventListener('resize', () => {
            if (simulation) {
                const width = window.innerWidth - 280;
                const height = window.innerHeight - 48 - 49;
                svg.attr('width', width).attr('height', height);
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        });
    </script>
</body>
</html>
