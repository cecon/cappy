<?xml version="1.0" encoding="UTF-8"?>
<cappy:script xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:noNamespaceSchemaLocation="script-knowstack.xsd" name="knowstack" version="2">
  <about>
    <summary>Descobrir a stack e registrá-la em .cappy/stack.md; configurar .cappy/config.yaml.</summary>
    <command>cappy:knowstack</command>
  </about>

  <steps>
    <step id="1.analyze">
      <goal>Elicitar e resolver dúvidas sobre a stack, uma pergunta por vez, até não restarem dúvidas materiais.</goal>
      <rules>
        <rule>Pergunte uma questão por vez; aguarde a resposta do usuário.</rule>
        <rule>Após cada resposta, refine entendimento e liste dúvidas restantes.</rule>
        <rule>Pare quando unanswered_doubts == 0.</rule>
      </rules>
      <output>internal_context.stack_understanding</output>
    </step>

    <step id="2.write_stack_md">
      <goal>Escrever .cappy/stack.md em inglês como single source of truth da stack.</goal>
      <fields>
        <field>LanguagesFrameworks</field>
        <field>ProjectStructure</field>
        <field>DependenciesVersions</field>
        <field>CodingStandards</field>
        <field>BuildTestCICD</field>
        <field>RuntimeDeployEnvs</field>
        <field>ObservabilityTooling</field>
        <field>ConstraintsNonGoals</field>
      </fields>
      <validate>Peça aprovação do usuário antes de gravar.</validate>
    </step>

    <step id="3.write_cappy_config">
      <goal>Criar/atualizar .cappy/config.yaml como fonte de configuração do Cappy.</goal>
      <yaml>
        version: 1
        language: pt-BR
        stack:
          source: ".cappy/stack.md"
          validated: true
          validated-at: "{{ now_utc_iso }}"
          validated-by: "user-confirmation"
        preferences:
          task:
            requireTitle: false
            defaultArea: fullstack
            maxHours: 3
      </yaml>
      <rules>
        <rule>Se existir .cappy/config.json, manter em YAML (migrar campos equivalentes quando possível).</rule>
      </rules>
    </step>

    <step id="4.commit">
      <goal>Commitar mudanças com mensagens claras.</goal>
      <commands>
        <cmd>git add .cappy/stack.md .cappy/config.yaml</cmd>
        <cmd>git commit -m "docs(cappy): add/update stack.md and config.yaml"</cmd>
      </commands>
    </step>

    <step id="5.next_flow">
      <goal>Prosseguir com os fluxos Cappy usando a stack aprovada como base.</goal>
    </step>
  </steps>
</cappy:script>
